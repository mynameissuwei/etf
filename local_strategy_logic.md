# `local_strategy.py` 逻辑说明

本文档概述 `local_strategy.py` 中本地化 ETF 动量轮动策略的主要组成和运行流程，帮助快速理解代码结构与关键参数。

## 1. 策略概览

- 目标：在指定 ETF 池中寻找动量最强的标的，按日轮动持仓。
- 数据来源：本地 CSV 数据文件，位于 `/home/suwei/回测策略/data`。
- 初始设置：默认动量参考窗口为 25 个交易日，初始资金 100,000 元，一次持有 1 只 ETF。

```text
LocalETFStrategy.__init__ → load_data → run_backtest → trade / update_portfolio_value
```

## 2. 数据加载与初始化

- **ETF 配置**：`self.etf_config` 中维护代码、名称及对应 CSV 文件名（如 159509 纳指科技 ETF、161116 黄金 ETF）。
- **load_data**：
  - 读取每个 CSV，统一列名为 `date` 和 `close`。
  - 将 `date` 转为索引并排序，过滤缺失值。
  - 为每只 ETF 建立初始持仓记录，资金状态存入 `self.portfolio`。
- 若数据读取失败会打印提示，但不会终止程序。

## 3. 交易日历

- `get_trading_dates` 对所有 ETF 的日期取交集，确保同一日都能获取价格。
- 交易日从第 `m_days`（25） 个样本之后开始，保证可计算完整动量窗口。
- 支持 `start_date` / `end_date` 过滤回测区间。

## 4. 动量评分（MOM）

`MOM(etf_code, end_date)` 延续聚宽策略的加权动量逻辑。每一步的设计都有明确目的：

1. **最近 25 日价格 (`price_data`)**：选取一个月左右的交易日，既能反映当前趋势，又避免样本过短导致噪声过大。
2. **对数价格 `y = ln(price)`**：对数收益近似可加性，便于线性拟合并削弱价格量级差异。例如价格从 1.70 到 1.87 的涨幅，经对数转换后变为稳定的线性序列。
3. **权重从 1 增至 2**：让最新交易日的权重约为最早的一倍，提高策略对近期趋势变化的敏感度，避免久远数据“拖后腿”。
4. **加权线性回归 (`np.polyfit`) 计算斜率 `slope`**：斜率表示对数价格的日均变化率，也就是平均“对数收益”。
5. **年化收益率 `annualized_returns = (e^slope)^250 - 1`**：将日均对数收益转成可直观比较的年化收益，250 代表常见的年交易日数。
6. **加权判定系数 `r_squared`**：衡量拟合优度，越接近 1 说明趋势越平滑。若近期虽然涨幅大但波动剧烈，`r_squared` 会被压低。
7. **综合评分 `score = annualized_returns * r_squared`**：收益和稳定性缺一不可，两者相乘后，高收益但不稳定会被降权，稳健但涨幅小也难以脱颖而出。

返回值是 `(score, details)`，其中 `details` 记下年化收益率、R²、斜率以及 25 日窗口的起始/结束净值。若样本不足或出现异常，统一返回 `-999` 作为占位，并给出原因。

### 示例：2025-09-01 的纳指科技 ETF（159509）

从 `analysis_results/backtest_results.csv` 可找到这一日的评分拆解：

- 25 日起始/结束净值：`1.772 → 1.853`。
- 加权回归斜率 `slope ≈ 0.00198`，表示对数价格每日增加约 0.198%。
- 换算成年化收益率 `annualized_returns ≈ 63.91%`，对应一段强劲的上涨趋势。
- 加权判定系数 `r_squared ≈ 0.463`，说明趋势较为平滑，回归能解释 46% 左右的加权方差。
- 综合评分 `score ≈ 0.296`，较高，因而该日策略会优先选择 159509 持仓。

同一天黄金 ETF（161116）的评分仅为 `0.00966`：虽然 25 日涨幅小幅上行（净值 `1.305 → 1.322`），但年化收益率只有 `8.49%`，R² 也较低（`0.113`），因此综合得分明显落后。这也展示了评分在“收益+稳定”两方面的平衡效果。

## 5. 排名与交易决策

- `get_rank` 为当前日期计算所有 ETF 的评分，返回按得分排序的列表及评分明细。
- `trade(date)`：
  - 选取得分最高的 ETF 作为目标持仓。
  - 若当前持仓为空或不是目标，则卖出原仓并用全部现金买入目标。
  - 记录每笔交易（买/卖方向、数量、价格、金额）。
  - 当日评分和拆解细节保存在 `self.daily_scores` / `self.daily_score_details`，用于后续写入 CSV。

## 6. 组合估值与历史记录

- `update_portfolio_value` 根据当日价格更新每个仓位的市值，加总得到组合总资产。
- `run_backtest`：
  - 遍历所有交易日，依次执行 `trade` 和 `update_portfolio_value`。
  - 记录 `history_record`，包括：日期、总资产、现金、当前持仓、持仓字典以及每只 ETF 的评分拆解（评分、年化收益率、R²、斜率、起止净值）。

## 7. 回测结果输出

- `print_backtest_results` 统计并打印：
  - 初始/最终资金、总收益率、年化收益率。
  - 回测时长、最大回撤、最终持仓结构。
- 将每日历史数据导出到 `/home/suwei/回测策略/analysis_results/backtest_results.csv`，列包含：
  - `日期`、`总市值`、`现金`、`当前持仓`。
  - 每只 ETF 的评分及拆分指标（如 `纳指科技ETF评分`、`纳指科技ETF年化收益率`、`…R平方`、`…斜率`、`…起始净值`、`…结束净值`）。
- 将交易流水保存到 `analysis_results/trades_record.csv`。

## 8. 命令行入口

- `main()` 创建策略实例并默认执行 `run_backtest(start_date='2024-01-01', end_date='2025-09-19')`。
- 在命令行运行：

```bash
python3 local_strategy.py
```

执行后可在终端查看调仓日志，CSV 文件中查看评分细节及资金曲线。

## 9. 常见扩展点

- 调整 `self.etf_config` 增加/替换 ETF，确保数据文件存在。
- 修改 `self.m_days` 以使用不同的动量窗口长度。
- 增加交易费用、滑点或资金管理逻辑时，可在 `trade` 函数中扩展。
- 引入更多评分指标，或在导出时增加自定义列。

以上即为 `local_strategy.py` 的核心逻辑及运行流程说明。
